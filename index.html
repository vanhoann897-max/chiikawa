<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒÇn C·∫£ Th·∫ø Gi·ªõi C√πng Chiikawa</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Thi·∫øt l·∫≠p font cho to√†n b·ªô ·ª©ng d·ª•ng */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fce4ec; /* Light Pink for Chiikawa theme */
        }
        /* Style cho n√∫t khi b·ªã disable */
        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Th√™m style cho th·∫ª card chung */
        .chiikawa-card {
            border-radius: 1.5rem; /* rounded-3xl */
            transition: all 0.3s ease;
            box-shadow: 0 10px 15px -3px rgba(236, 72, 153, 0.3), 0 4px 6px -2px rgba(236, 72, 153, 0.1);
        }

        /* Th·∫ª nh√¢n v·∫≠t khi ƒë∆∞·ª£c ch·ªçn */
        .character-card.selected {
            border: 4px solid #9333ea; /* Ring purple */
            background-color: #f3e8ff; /* Light purple */
            transform: scale(1.05);
            box-shadow: 0 20px 25px -5px rgba(147, 51, 234, 0.5), 0 8px 10px -6px rgba(147, 51, 234, 0.3);
        }

        /* Thanh progress bar gi·∫£ l·∫≠p */
        .progress-bar {
            height: 8px;
            border-radius: 9999px;
            background-color: #fbcfe8; /* pink-200 */
        }

        .progress-fill {
            height: 100%;
            border-radius: 9999px;
            background-color: #db2777; /* pink-600 */
            transition: width 0.5s ease-out;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Container ch√≠nh (Kh√¥ng c·∫ßn loading overlay n·ªØa v√¨ kh√¥ng t·∫£i d·ªØ li·ªáu) -->
    <div id="app-container" class="p-4 sm:p-8">
        <!-- Khu v·ª±c ti√™u ƒë·ªÅ v√† tr·∫°ng th√°i s·∫Ω ƒë∆∞·ª£c render t·∫°i ƒë√¢y -->
        <header id="app-header" class="text-center mb-10"></header>

        <!-- Khu v·ª±c tr·∫°ng th√°i ch√≠nh -->
        <main class="max-w-7xl mx-auto bg-white chiikawa-card p-6 sm:p-12">

            <!-- Thanh Tab Chuy·ªÉn ƒë·ªïi -->
            <div class="flex mb-8 border-b-2 border-pink-200" id="tab-nav">
                <!-- Buttons s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
            </div>
            
            <!-- Khu v·ª±c th√¥ng b√°o mua b√°n -->
            <div id="message-area" class="mb-6 hidden"></div>

            <!-- N·ªôi dung ch√≠nh d·ª±a tr√™n Tab -->
            <div id="main-content">
                <!-- N·ªôi dung Eating ho·∫∑c Shop s·∫Ω ƒë∆∞·ª£c render t·∫°i ƒë√¢y -->
            </div>
            
        </main>
        
        <!-- Ch√¢n trang -->
        <footer class="text-center mt-10 text-pink-400 text-sm">
            üíñ ·ª®ng d·ª•ng gi·∫£ l·∫≠p ƒÉn u·ªëng Chiikawa. H√£y ch∆°i vui v·∫ª! (Tr·∫°ng th√°i game s·∫Ω reset khi t·∫£i l·∫°i trang) üíñ
        </footer>
    </div>

    <script type="module">
        // --- D·ªÆ LI·ªÜU C·ªê ƒê·ªäNH (Kh√¥ng thay ƒë·ªïi) ---

        const CHARACTERS = ["Chiikawa", "Hachiware", "Usagi"];
        
        // 15 LO·∫†I N∆Ø·ªöC S·ªêT
        const SAUCES = [
            { id: 'Sauce1', name: "S·ªët M·∫≠t Ong", emoji: "üçØ", bonus: 20, price: 15 },
            { id: 'Sauce2', name: "S·ªët T∆∞∆°ng ·ªöt", emoji: "üå∂Ô∏è", bonus: 25, price: 20 },
            { id: 'Sauce3', name: "S·ªët Chanh D√¢y", emoji: "üçã", bonus: 15, price: 10 },
            { id: 'Sauce4', name: "S·ªët N·∫•m Truffle", emoji: "üçÑ", bonus: 30, price: 25 },
            { id: 'Sauce5', name: "S·ªët Pesto Basil", emoji: "üåø", bonus: 18, price: 16 },
            { id: 'Sauce6', name: "S·ªët T·ªèi B∆°", emoji: "üßà", bonus: 22, price: 17 },
            { id: 'Sauce7', name: "S·ªët BBQ Kh√≥i", emoji: "üî•", bonus: 20, price: 18 },
            { id: 'Sauce8', name: "S·ªët Ph√¥ Mai Kem", emoji: "üßÄ", bonus: 28, price: 22 },
            { id: 'Sauce9', name: "S·ªët G·ª´ng T∆∞∆°i", emoji: "üçö", bonus: 12, price: 10 },
            { id: 'Sauce10', name: "S·ªët Wasabi C·ª±c Cay", emoji: "ü§Ø", bonus: 35, price: 30 },
            { id: 'Sauce11', name: "S·ªët Ti√™u ƒêen", emoji: "üñ§", bonus: 19, price: 15 },
            { id: 'Sauce12', name: "S·ªët Cam Th·∫£o", emoji: "üçä", bonus: 17, price: 12 },
            { id: 'Sauce13', name: "S·ªët Xo√†i Cay", emoji: "ü•≠", bonus: 27, price: 21 },
            { id: 'Sauce14', name: "S·ªët B∆° H·∫°t D·∫ª", emoji: "üå∞", bonus: 24, price: 19 },
            { id: 'Sauce15', name: "S·ªët M√π T·∫°t Ng·ªçt", emoji: "üíõ", bonus: 16, price: 11 },
        ];
        const SAUCE_IDS = SAUCES.map(s => s.id);
        
        // H√†m Utility ƒë·ªÉ l·∫•y ng·∫´u nhi√™n 1 ph·∫ßn t·ª≠ t·ª´ m·∫£ng
        const getRandomElement = (array) => array[Math.floor(Math.random() * array.length)];
        
        // H√†m Utility ƒë·ªÉ g√°n ng·∫´u nhi√™n c√°c thu·ªôc t√≠nh s·ªü th√≠ch
        const assignRandomPreferences = () => {
            const favoriteCharacter = getRandomElement(CHARACTERS);
            const avoidSauceId = getRandomElement(SAUCE_IDS);
            
            const availableFailCharacters = CHARACTERS.filter(c => c !== favoriteCharacter);
            const criticalFailCharacter = getRandomElement(availableFailCharacters);

            return { favoriteCharacter, avoidSauceId, criticalFailCharacter };
        };

        // 12 m√≥n ƒÉn ban ƒë·∫ßu (Nh·∫≠t/Qu·ªëc t·∫ø)
        const initialFoodTemplates = [
            { id: 1, name: "B√°nh Kem (ƒêB)", emoji: "üç∞", satisfaction: 90, price: 50, type: "Perfect", flavor: "Sweet" }, 
            { id: 2, name: "Ramen N√≥ng", emoji: "üçú", satisfaction: 75, price: 30, type: "Good", flavor: "Umami" }, 
            { id: 3, name: "Takoyaki", emoji: "üêô", satisfaction: 60, price: 25, type: "Normal", flavor: "Savory" }, 
            { id: 4, name: "Sushi C√° H·ªìi", emoji: "üç£", satisfaction: 95, price: 60, type: "Perfect", flavor: "Umami" }, 
            { id: 5, name: "Hamburger", emoji: "üçî", satisfaction: 85, price: 45, type: "Good", flavor: "Savory" }, 
            { id: 6, name: "B√°nh M√¨ K·∫πp", emoji: "ü•™", satisfaction: 55, price: 20, type: "Normal", flavor: "Savory" }, 
            { id: 7, name: "D√¢u T√¢y L·ªõn", emoji: "üçì", satisfaction: 65, price: 35, type: "Good", flavor: "Sweet" }, 
            { id: 8, name: "Kem ·ªêc Qu·∫ø", emoji: "üç¶", satisfaction: 70, price: 40, type: "Good", flavor: "Sweet" }, 
            { id: 9, name: "B√°nh D·ª©a", emoji: "üçç", satisfaction: 50, price: 25, type: "Normal", flavor: "Sour" }, 
            { id: 10, name: "K·∫πo Ng·ªçt", emoji: "üç¨", satisfaction: 20, price: 5, type: "Simple", flavor: "Sweet" }, 
            { id: 11, name: "M√¨ √ù Carbonara", emoji: "üçù", satisfaction: 80, price: 40, type: "Good", flavor: "Creamy" },
            { id: 12, name: "Pizza H·∫£i S·∫£n", emoji: "üçï", satisfaction: 92, price: 55, type: "Perfect", flavor: "Savory" },
        ];
        
        // 15 M√ìN ƒÇN VI·ªÜT NAM M·ªöI (L·∫ßn 1)
        const vietnameseFoodTemplates = [
            { id: 13, name: "Ph·ªü B√≤ Truy·ªÅn Th·ªëng", emoji: "üç≤", satisfaction: 98, price: 70, type: "Perfect", flavor: "Umami" },
            { id: 14, name: "B√°nh M√¨ Th·ªãt N∆∞·ªõng", emoji: "ü•ñ", satisfaction: 88, price: 45, type: "Good", flavor: "Savory" },
            { id: 15, name: "B√∫n Ch·∫£ H√† N·ªôi", emoji: "üçú", satisfaction: 90, price: 55, type: "Perfect", flavor: "Savory" },
            { id: 16, name: "C∆°m T·∫•m S∆∞·ªùn B√¨ Ch·∫£", emoji: "üçö", satisfaction: 93, price: 60, type: "Perfect", flavor: "Savory" },
            { id: 17, name: "G·ªèi Cu·ªën T√¥m Th·ªãt", emoji: "üåØ", satisfaction: 75, price: 35, type: "Good", flavor: "Fresh" },
            { id: 18, name: "B√°nh X√®o Gi√≤n", emoji: "ü•û", satisfaction: 80, price: 40, type: "Good", flavor: "Savory" },
            { id: 19, name: "Cao L·∫ßu H·ªôi An", emoji: "üçù", satisfaction: 85, price: 50, type: "Good", flavor: "Umami" },
            { id: 20, name: "Ch·∫£ Gi√≤ (Nem R√°n)", emoji: "üç§", satisfaction: 78, price: 30, type: "Good", flavor: "Savory" },
            { id: 21, name: "B√°nh Kh·ªçt V≈©ng T√†u", emoji: "üßÄ", satisfaction: 70, price: 38, type: "Normal", flavor: "Savory" },
            { id: 22, name: "B√°nh B·ªôt L·ªçc", emoji: "ü•ü", satisfaction: 65, price: 28, type: "Normal", flavor: "Umami" },
            { id: 23, name: "B√°nh CƒÉn Phan Rang", emoji: "ü•ö", satisfaction: 68, price: 32, type: "Normal", flavor: "Savory" },
            { id: 24, name: "M√¨ Qu·∫£ng", emoji: "üçú", satisfaction: 91, price: 58, type: "Perfect", flavor: "Umami" },
            { id: 25, name: "B√∫n Ri√™u Cua", emoji: "ü¶Ä", satisfaction: 83, price: 48, type: "Good", flavor: "Umami" },
            { id: 26, name: "L·∫©u M·∫Øm Mi·ªÅn T√¢y", emoji: "ü•ò", satisfaction: 96, price: 75, type: "Perfect", flavor: "Strong" },
            { id: 27, name: "B√°nh Tr√°ng Tr·ªôn", emoji: "ü•ó", satisfaction: 55, price: 25, type: "Normal", flavor: "Spicy" },
        ];

        // 20 M√ìN ƒÇN VI·ªÜT NAM M·ªöI (L·∫ßn 2) - B·∫ÆT ƒê·∫¶U T·ª™ ID 28
        const moreVietnameseFoodTemplates = [
            { id: 28, name: "B√°nh Gi√≤", emoji: "üçö", satisfaction: 65, price: 30, type: "Good", flavor: "Savory" },
            { id: 29, name: "B√°nh Cu·ªën N√≥ng", emoji: "üçö", satisfaction: 80, price: 40, type: "Good", flavor: "Fresh" },
            { id: 30, name: "X√¥i X√©o", emoji: "üçö", satisfaction: 70, price: 35, type: "Good", flavor: "Savory" },
            { id: 31, name: "Ch√°o L√≤ng", emoji: "ü•£", satisfaction: 60, price: 28, type: "Normal", flavor: "Umami" },
            { id: 32, name: "Ph·ªü Cu·ªën", emoji: "üåØ", satisfaction: 75, price: 38, type: "Good", flavor: "Fresh" },
            { id: 33, name: "B√∫n B√≤ Hu·∫ø", emoji: "üç≤", satisfaction: 95, price: 65, type: "Perfect", flavor: "Spicy" },
            { id: 34, name: "B√°nh Canh Cua", emoji: "üçú", satisfaction: 85, price: 50, type: "Good", flavor: "Umami" },
            { id: 35, name: "·ªêc Lu·ªôc", emoji: "üêö", satisfaction: 68, price: 33, type: "Normal", flavor: "Spicy" },
            { id: 36, name: "Ch√® Khoai M√¥n", emoji: "üçÆ", satisfaction: 72, price: 35, type: "Good", flavor: "Sweet" },
            { id: 37, name: "B√°nh B√≤ N∆∞·ªõng", emoji: "üç∞", satisfaction: 60, price: 25, type: "Normal", flavor: "Sweet" },
            { id: 38, name: "Th·ªãt Kho Tr·ª©ng", emoji: "üç≥", satisfaction: 90, price: 55, type: "Perfect", flavor: "Savory" },
            { id: 39, name: "Canh Chua C√°", emoji: "üêü", satisfaction: 88, price: 52, type: "Good", flavor: "Sour" },
            { id: 40, name: "B√°nh ƒê√∫c N√≥ng", emoji: "üçö", satisfaction: 55, price: 22, type: "Simple", flavor: "Savory" },
            { id: 41, name: "B√∫n ƒê·∫≠u M·∫Øm T√¥m", emoji: "üçú", satisfaction: 99, price: 75, type: "Perfect", flavor: "Strong" },
            { id: 42, name: "B√°nh P√≠a", emoji: "ü•Æ", satisfaction: 63, price: 30, type: "Normal", flavor: "Sweet" },
            { id: 43, name: "Nem Chua R√°n", emoji: "ü•ì", satisfaction: 78, price: 38, type: "Good", flavor: "Savory" },
            { id: 44, name: "B√∫n Ri√™u T√¥m", emoji: "üç≤", satisfaction: 82, price: 45, type: "Good", flavor: "Umami" },
            { id: 45, name: "B√°nh G·ªëi", emoji: "ü•ü", satisfaction: 66, price: 31, type: "Normal", flavor: "Savory" },
            { id: 46, name: "Ch√® Th√°i", emoji: "üçß", satisfaction: 75, price: 40, type: "Good", flavor: "Sweet" },
            { id: 47, name: "B√°nh T√©t", emoji: "üéÅ", satisfaction: 85, price: 48, type: "Good", flavor: "Umami" },
        ];


        // 73 m√≥n ƒÉn placeholder ƒë·ªÉ ƒë·ªß 120 m√≥n (12 + 35 + 73 = 120)
        const generatePlaceholderFoods = (startId) => {
            const placeholders = [];
            const baseEmojis = ["üçÑ", "üç©", "üçø", "üçá", "ü•ï", "ü•ö", "ü•ê", "üßá", "üçû", "üßÄ"];
            const baseNames = ["B·ªØa ƒÉn b√≠ ·∫©n", "M√≥n tr√°ng mi·ªáng", "ƒê·ªì ƒÉn nh·∫π", "Th·ª±c ph·∫©m t∆∞∆°i"];
            const flavors = ["Sweet", "Savory", "Umami", "Bitter", "Sour", "Creamy"];
            
            for (let i = 0; i < 73; i++) { 
                const satisfaction = 20 + Math.floor(Math.random() * 80);
                const price = Math.round(satisfaction * 0.6) + 5; 
                
                let type;
                if (satisfaction >= 85) type = "Perfect";
                else if (satisfaction >= 60) type = "Good";
                else if (satisfaction >= 40) type = "Normal";
                else type = "Simple";

                placeholders.push({
                    id: startId + i,
                    name: `${baseNames[(i + 1) % baseNames.length]} ${i + 1}`,
                    emoji: baseEmojis[(i + 1) % baseEmojis.length],
                    satisfaction,
                    price,
                    type,
                    flavor: getRandomElement(flavors),
                    ...assignRandomPreferences(),
                });
            }
            return placeholders;
        };
        
        // 20 LO·∫†I N∆Ø·ªöC GI·∫¢I KH√ÅT (Nh·∫≠t/Qu·ªëc t·∫ø)
        const initialBeveragesTemplates = [
            { id: 101, name: "Tr√† S·ªØa Tr√¢n Ch√¢u", emoji: "üßã", satisfaction: 45, price: 20, type: "Good", flavor: "Sweet" }, 
            { id: 102, name: "C√† Ph√™ L·∫°nh", emoji: "‚òï", satisfaction: 30, price: 15, type: "Simple", flavor: "Bitter" }, 
            { id: 103, name: "N∆∞·ªõc √âp T√°o", emoji: "üçé", satisfaction: 55, price: 25, type: "Good", flavor: "Sweet" }, 
            { id: 104, name: "N∆∞·ªõc Kho√°ng", emoji: "üíß", satisfaction: 10, price: 5, type: "Simple", flavor: "Neutral" }, 
            { id: 105, name: "S√¥-c√¥-la N√≥ng", emoji: "üç´", satisfaction: 60, price: 30, type: "Perfect", flavor: "Sweet" }, 
            { id: 106, name: "Sinh T·ªë B∆°", emoji: "ü•ë", satisfaction: 50, price: 28, type: "Good", flavor: "Creamy" }, 
            { id: 107, name: "Soda Chanh", emoji: "üçπ", satisfaction: 35, price: 18, type: "Simple", flavor: "Sour" }, 
            { id: 108, name: "N∆∞·ªõc Ramune", emoji: "ü•§", satisfaction: 40, price: 15, type: "Normal", flavor: "Sweet" }, 
            { id: 109, name: "N∆∞·ªõc D·ª´a T∆∞∆°i", emoji: "ü••", satisfaction: 50, price: 22, type: "Good", flavor: "Sweet" }, 
            { id: 110, name: "Smoothie D√¢u", emoji: "üçì", satisfaction: 65, price: 35, type: "Perfect", flavor: "Sweet" }, 
            { id: 111, name: "Bia G·ª´ng", emoji: "üç∫", satisfaction: 30, price: 15, type: "Simple", flavor: "Spicy" }, 
            { id: 112, name: "N∆∞·ªõc B√≠ ƒêao", emoji: "üçµ", satisfaction: 40, price: 12, type: "Normal", flavor: "Herbal" }, 
            { id: 113, name: "L·ª•c Tr√† Matcha", emoji: "üçµ", satisfaction: 55, price: 25, type: "Good", flavor: "Bitter" }, 
            { id: 114, name: "S·ªØa Chua U·ªëng", emoji: "ü•õ", satisfaction: 45, price: 18, type: "Normal", flavor: "Sour" }, 
            { id: 115, name: "N∆∞·ªõc Cam √âp", emoji: "üçä", satisfaction: 60, price: 30, type: "Good", flavor: "Sweet" }, 
            { id: 116, name: "Mojito (Kh√¥ng C·ªìn)", emoji: "üåø", satisfaction: 50, price: 25, type: "Normal", flavor: "Minty" }, 
            { id: 117, name: "Kombucha", emoji: "üè∫", satisfaction: 35, price: 20, type: "Simple", flavor: "Sour" }, 
            { id: 118, name: "H·ªìng Tr√† ƒê√°", emoji: "üßä", satisfaction: 25, price: 10, type: "Simple", flavor: "Bitter" }, 
            { id: 119, name: "S·ªØa L√∫a M·∫°ch", emoji: "üåæ", satisfaction: 45, price: 22, type: "Normal", flavor: "Sweet" }, 
            { id: 120, name: "Kem Tuy·∫øt M√£ng C·∫ßu", emoji: "üçß", satisfaction: 70, price: 40, type: "Perfect", flavor: "Sweet" }, 
        ];

        // 15 N∆Ø·ªöC GI·∫¢I KH√ÅT VI·ªÜT NAM (ƒê√£ ƒë·ªïi t√™n ID 121 th√†nh "Sinh T·ªë Rau M√°")
        const vietnameseBeveragesTemplates = [
            { id: 121, name: "Sinh T·ªë Rau M√°", emoji: "üåø", satisfaction: 78, price: 38, type: "Perfect", flavor: "Cooling" }, // ƒê√É ƒê·ªîI T√äN
            { id: 122, name: "C√† Ph√™ Tr·ª©ng", emoji: "‚òï", satisfaction: 90, price: 50, type: "Perfect", flavor: "Creamy" },
            { id: 123, name: "Tr√† Chanh Gi√£ Tay", emoji: "üçã", satisfaction: 65, price: 30, type: "Good", flavor: "Sour" },
            { id: 124, name: "N∆∞·ªõc S√¢m L·∫°nh", emoji: "üå±", satisfaction: 55, price: 25, type: "Good", flavor: "Herbal" },
            { id: 125, name: "Sinh T·ªë Sapoche", emoji: "üçÆ", satisfaction: 70, price: 40, type: "Good", flavor: "Sweet" },
            { id: 126, name: "S·ªØa Chua ƒê√°nh ƒê√°", emoji: "üßä", satisfaction: 80, price: 45, type: "Perfect", flavor: "Sour" },
            { id: 127, name: "Ch√® Ba M√†u", emoji: "üçß", satisfaction: 60, price: 30, type: "Good", flavor: "Sweet" },
            { id: 128, name: "T·∫Øc X√≠ Mu·ªôi", emoji: "üçä", satisfaction: 45, price: 20, type: "Normal", flavor: "Sour" },
            { id: 129, name: "N∆∞·ªõc M√≠a", emoji: "üéã", satisfaction: 50, price: 15, type: "Normal", flavor: "Sweet" },
            { id: 130, name: "Tr√† ƒê√° V·ªâa H√®", emoji: "üßä", satisfaction: 20, price: 5, type: "Simple", flavor: "Bitter" },
            { id: 131, name: "N∆∞·ªõc √âp D·ª©a", emoji: "üçç", satisfaction: 60, price: 30, type: "Good", flavor: "Sour" },
            { id: 132, name: "B·∫°c X·ªâu", emoji: "ü•õ", satisfaction: 75, price: 40, type: "Perfect", flavor: "Sweet" },
            { id: 133, name: "N∆∞·ªõc M∆°", emoji: "üçë", satisfaction: 40, price: 18, type: "Normal", flavor: "Sour" },
            { id: 134, name: "R∆∞·ª£u N·∫øp C·∫©m (Ch√®)", emoji: "üç∑", satisfaction: 50, price: 25, type: "Normal", flavor: "Sweet" },
            { id: 135, name: "N∆∞·ªõc Chanh Mu·ªëi", emoji: "üßÇ", satisfaction: 35, price: 15, type: "Simple", flavor: "Salty" },
        ];


        const allFoodTemplates = [...initialFoodTemplates, ...vietnameseFoodTemplates, ...moreVietnameseFoodTemplates];
        const initialFoodMenu = allFoodTemplates.map(food => ({ ...food, category: 'food', ...assignRandomPreferences() }));
        
        // B·∫Øt ƒë·∫ßu ID cho Placeholder t·ª´ 48 (12 + 15 + 20 + 1)
        const placeholderFoods = generatePlaceholderFoods(initialFoodTemplates.length + vietnameseFoodTemplates.length + moreVietnameseFoodTemplates.length + 1).map(food => ({ ...food, category: 'food' }));
        
        const allBeveragesTemplates = [...initialBeveragesTemplates, ...vietnameseBeveragesTemplates];
        const BEVERAGES = allBeveragesTemplates.map(item => ({ ...item, category: 'beverage', ...assignRandomPreferences() }));

        const FOOD_MENU = [...initialFoodMenu, ...placeholderFoods]; // T·ªïng 120 m√≥n ƒÉn
        
        // --- STATE QU·∫¢N L√ù (S·∫Ω reset khi t·∫£i l·∫°i) ---
        
        const getDefaultState = () => ({
            characterSatisfaction: {
                Chiikawa: 0,
                Hachiware: 0,
                Usagi: 0,
            },
            money: 600, 
            inventory: FOOD_MENU.reduce((acc, food) => {
                acc[food.id] = food.id === 1 ? 2 : 0; 
                return acc;
            }, {}),
            sauceInventory: SAUCES.reduce((acc, sauce) => {
                acc[sauce.id] = sauce.id === 'Sauce1' ? 1 : 0; 
                return acc;
            }, {}),
            beverageInventory: BEVERAGES.reduce((acc, beverage) => {
                acc[beverage.id] = beverage.id === 101 ? 1 : 0; 
                return acc;
            }, {}),

            // ƒê·∫∑t selectedItem l√† m·ªôt object ƒë∆°n gi·∫£n
            selectedItem: { id: FOOD_MENU[0].id, category: 'food' }, 
            selectedSauceId: null, 
            selectedCharacter: "Chiikawa", 
            feedback: "Ch·ªçn m√≥n v√† Nh√¢n v·∫≠t ƒë·ªÉ b·∫Øt ƒë·∫ßu!",
            mood: { Chiikawa: "neutral", Hachiware: "neutral", Usagi: "neutral" }, 
            activeTab: 'eat', 
            musicUrl: "chiiik.WAV",
        });

        let state = getDefaultState();
        
        // --- UTILITY FUNCTIONS ---

        const getItemDataFromState = (selectedItem) => {
            if (selectedItem.category === 'food') return getFoodById(selectedItem.id);
            if (selectedItem.category === 'beverage') return getBeverageById(selectedItem.id);
            return null;
        }

        const getSauceById = (id) => SAUCES.find(s => s.id === id);
        const getFoodById = (id) => FOOD_MENU.find(f => f.id === id);
        const getBeverageById = (id) => BEVERAGES.find(b => b.id === id);

        const getItemById = (id, category) => {
            if (category === 'food') return getFoodById(id);
            if (category === 'beverage') return getBeverageById(id);
            return null;
        }

        const getAvoidSauceName = (selectedItemData) => {
            if (!selectedItemData || !selectedItemData.avoidSauceId) return "Kh√¥ng c√≥";
            const sauce = getSauceById(selectedItemData.avoidSauceId);
            return sauce ? sauce.name : "Kh√¥ng c√≥";
        };

        const getInventoryCount = (item) => {
            if (item.category === 'food') return state.inventory[item.id] || 0;
            if (item.category === 'beverage') return state.beverageInventory[item.id] || 0;
            return 0; // Should not happen for food/beverage
        };

        const getTotalSatisfaction = () => {
            return state.characterSatisfaction.Chiikawa + state.characterSatisfaction.Hachiware + state.characterSatisfaction.Usagi;
        };

        const getTypeColor = (type) => {
            switch (type) {
                case "Perfect": return "border-red-500 bg-red-100";
                case "Good": return "border-yellow-500 bg-yellow-100";
                case "Normal": return "border-green-500 bg-green-100";
                case "Simple": return "border-blue-500 bg-blue-100";
                default: return "border-gray-300 bg-gray-100";
            }
        };

        const updateMessage = (msg, isSuccess = true) => {
            state.message = msg;
            const msgArea = document.getElementById('message-area');
            msgArea.textContent = msg;
            msgArea.className = `mb-6 p-4 rounded-xl text-center font-extrabold shadow-lg transition-all duration-300 ${isSuccess ? 'bg-green-100 text-green-700 border-2 border-green-300' : 'bg-red-100 text-red-700 border-2 border-red-300'}`;
            msgArea.classList.remove('hidden');
            setTimeout(() => {
                 msgArea.classList.add('hidden');
                 state.message = '';
            }, 3000);
        };
        
        // --- HANDLERS (LOGIC) ---
        // C√°c h√†m x·ª≠ l√Ω s·ª± ki·ªán c·∫ßn ƒë∆∞·ª£c g√°n v√†o window ƒë·ªÉ truy c·∫≠p t·ª´ onclick inline

        // T√çNH NƒÇNG ƒê·ªîI NH·∫†C B·∫∞NG URL/T√äN FILE
        window.handleUpdateMusicUrl = () => {
            const input = document.getElementById('new-music-url');
            let newUrl = input.value.trim();

            if (!newUrl) {
                newUrl = "chiiik.WAV"; 
            }
            
            // X·ª≠ l√Ω thu h·ªìi URL c≈© n·∫øu l√† blob (t·∫£i l√™n file)
            if (state.musicUrl.startsWith('blob:') && newUrl !== state.musicUrl) {
                URL.revokeObjectURL(state.musicUrl);
            }

            state.musicUrl = newUrl;
            renderHeader(); 
            updateMessage(`ƒê√£ c·∫≠p nh·∫≠t nh·∫°c n·ªÅn th√†nh: ${newUrl}`, true);
        }

        // T√çNH NƒÇNG ƒê·ªîI NH·∫†C B·∫∞NG FILE UPLOAD
        window.handleMusicFileUpload = (event) => {
            const file = event.target.files[0];
            if (file) {
                // Thu h·ªìi URL c≈© tr∆∞·ªõc khi t·∫°o URL m·ªõi
                if (state.musicUrl.startsWith('blob:')) {
                    URL.revokeObjectURL(state.musicUrl);
                }
                
                const newUrl = URL.createObjectURL(file);
                state.musicUrl = newUrl;
                renderHeader();
                updateMessage(`‚úÖ ƒê√£ t·∫£i v√† c·∫≠p nh·∫≠t nh·∫°c n·ªÅn: ${file.name}`, true);
            } else {
                updateMessage("‚ùå Kh√¥ng t√¨m th·∫•y file nh·∫°c ƒë∆∞·ª£c ch·ªçn.", false);
            }
        }

        window.handleBuyItem = (item) => {
            if (state.money < item.price) {
                updateMessage("‚ùå Kh√¥ng ƒë·ªß ti·ªÅn (Gold) ƒë·ªÉ mua m√≥n n√†y!", false);
                return;
            }
            
            state.money -= item.price;
            
            if (item.category === 'sauce') {
                state.sauceInventory[item.id] = (state.sauceInventory[item.id] || 0) + 1;
            } else if (item.category === 'food') {
                state.inventory[item.id] = (state.inventory[item.id] || 0) + 1;
            } else if (item.category === 'beverage') {
                state.beverageInventory[item.id] = (state.beverageInventory[item.id] || 0) + 1;
            }

            updateMessage(`‚úÖ ƒê√£ mua th√†nh c√¥ng 1x ${item.name} v·ªõi gi√° ${item.price} G.`, true);
            
            renderAll();
        };

        window.handleSelectItem = (itemId, itemCategory) => {
            const item = getItemById(itemId, itemCategory);
            if (!item) return; 

            const inventory = (itemCategory === 'food') ? state.inventory : state.beverageInventory;

            if ((inventory[item.id] || 0) <= 0) {
                state.feedback = `‚ùå B·∫°n c·∫ßn mua ${item.name} (hi·ªán c√≥ 0) t·∫°i C·ª≠a H√†ng tr∆∞·ªõc khi ƒÉn.`;
                updateMessage(`Vui l√≤ng v√†o tab C·ª≠a H√†ng ƒë·ªÉ mua ${itemCategory === 'food' ? 'ƒë·ªì ƒÉn' : 'n∆∞·ªõc u·ªëng'}.`, false);
                renderContent();
                return;
            }
            state.selectedItem = { id: item.id, category: item.category }; // C·∫≠p nh·∫≠t state ƒë∆°n gi·∫£n
            state.feedback = `ƒê√£ ch·ªçn: ${item.name}. S·∫µn s√†ng cho ${state.selectedCharacter} ƒÉn!`;
            renderContent();
        };

        window.handleSelectCharacter = (name) => {
            state.selectedCharacter = name;
            const selectedItemData = getItemDataFromState(state.selectedItem);
            state.feedback = `ƒê√£ ch·ªçn: ${selectedItemData.name}. S·∫µn s√†ng cho ${state.selectedCharacter} ƒÉn!`;
            renderContent();
        };

        window.handleSelectSauce = (sauceId) => {
            const currentSauce = state.selectedSauceId;
            // B·ªè ch·ªçn n·∫øu nh·∫•p l·∫ßn n·ªØa v√†o s·ªët ƒëang ch·ªçn
            state.selectedSauceId = currentSauce === sauceId ? null : sauceId;
            renderContent(); 
        };

        window.handleEatFood = () => {
            const selectedItemData = getItemDataFromState(state.selectedItem);
            const selectedCharacter = state.selectedCharacter;
            
            const inventory = selectedItemData.category === 'food' ? state.inventory : state.beverageInventory;
            
            if (!selectedItemData || (inventory[selectedItemData.id] || 0) <= 0) {
                state.feedback = "‚ùå B·∫°n kh√¥ng c√≥ m√≥n ƒÉn/n∆∞·ªõc u·ªëng n√†y trong kho ho·∫∑c ch∆∞a ch·ªçn m√≥n!";
                renderContent();
                return;
            }

            const sauce = state.selectedSauceId ? getSauceById(state.selectedSauceId) : null;
            let satisfaction = selectedItemData.satisfaction;
            let bonusMessage = "";
            let moneyGain = 0;
            let newMood = "neutral";
            
            if (sauce && (state.sauceInventory[sauce.id] || 0) <= 0) {
                state.feedback = "‚ùå B·∫°n kh√¥ng c√≥ n∆∞·ªõc s·ªët n√†y trong kho!";
                state.selectedSauceId = null;
                renderContent();
                return;
            }

            // 1. T√≠nh to√°n ƒëi·ªÉm h√†i l√≤ng t·ª´ N∆∞·ªõc s·ªët
            if (sauce) {
                if (selectedItemData.avoidSauceId === sauce.id) {
                    // K·∫æT H·ª¢P SAI
                    satisfaction -= sauce.bonus; 
                    bonusMessage = `(K·∫æT H·ª¢P SAI: Gi·∫£m ${sauce.bonus} ƒëi·ªÉm!) üò•`;
                    
                    if (selectedItemData.criticalFailCharacter === selectedCharacter) {
                        satisfaction -= 20; // Gi·∫£m ƒëi·ªÉm ph·∫°t n·∫∑ng h∆°n
                        bonusMessage += ` (${selectedCharacter} c·ª±c k·ª≥ th·∫•t v·ªçng! -20 ƒëi·ªÉm th√™m)`;
                        newMood = "sad";
                    } else {
                        newMood = "neutral";
                    }

                    if (satisfaction < 0) satisfaction = 0; 
                } else {
                    // K·∫æT H·ª¢P ƒê√öNG
                    satisfaction += sauce.bonus;
                    bonusMessage = `(+${sauce.bonus} ƒëi·ªÉm t·ª´ S·ªët ${sauce.name}! K·∫æT H·ª¢P HO√ÄN H·∫¢O!) ü•≥`;
                    newMood = "happy";
                }

                // Gi·∫£m s·ªë l∆∞·ª£ng n∆∞·ªõc s·ªët
                state.sauceInventory[sauce.id] -= 1;
            }

            // 2. ƒêi·ªÉm bonus t·ª´ M√≥n t·ªß V√Ä TH∆Ø·ªûNG TI·ªÄN
            if (selectedItemData.favoriteCharacter === selectedCharacter) {
                satisfaction += 15; 
                moneyGain = 200; 
                bonusMessage += ` (M√ìN T·ª¶: +15 ƒëi·ªÉm Bonus & +${moneyGain} Gold!) ‚ú®`;
                newMood = "very_happy";
            } else {
                moneyGain = 25; 
                bonusMessage += ` (ƒÇn m√≥n l·∫°: +${moneyGain} Gold!)`;
            }
            
            // 3. C·∫≠p nh·∫≠t Ti·ªÅn (Gold)
            state.money += moneyGain;

            // 4. Gi·∫£m s·ªë l∆∞·ª£ng m√≥n ƒÉn/n∆∞·ªõc u·ªëng
            inventory[selectedItemData.id] -= 1;

            // 5. C·∫≠p nh·∫≠t t·ªïng ƒëi·ªÉm h√†i l√≤ng
            state.characterSatisfaction[selectedCharacter] += satisfaction;

            // 6. T·∫°o Ph·∫£n h·ªìi v√† C·∫£m x√∫c
            let newFeedback = "";
            
            if (satisfaction >= 90) {
                newFeedback = `PERFECT! ${selectedCharacter} C·ª∞C K·ª≤ H√ÄI L√íNG! (+${satisfaction} ƒëi·ªÉm) ${bonusMessage}`;
                if (newMood !== "very_happy") newMood = "very_happy"; 
            } else if (satisfaction >= 70) {
                newFeedback = `NGON! ${selectedCharacter} th√≠ch m√≥n n√†y! (+${satisfaction} ƒëi·ªÉm) ${bonusMessage}`;
                if (newMood === "neutral") newMood = "happy"; 
            } else if (satisfaction >= 40) {
                newFeedback = `·ªîN! ${selectedCharacter} ƒÉn r·ªìi! (+${satisfaction} ƒëi·ªÉm) ${bonusMessage}`;
                if (newMood === "sad") newMood = "neutral"; 
                else newMood = "neutral";
            } else {
                 newFeedback = `KH√îNG H√ÄI L√íNG! M√≥n n√†y t·ªá qu√°! (+${satisfaction} ƒëi·ªÉm) ${bonusMessage}`;
                 newMood = "sad";
            }
            
            state.feedback = newFeedback;
            state.mood[selectedCharacter] = newMood;
            state.selectedSauceId = null; 

            // C·∫≠p nh·∫≠t DOM
            renderAll();

            // ƒê·∫∑t l·∫°i tr·∫°ng th√°i c·∫£m x√∫c sau 2 gi√¢y
            setTimeout(() => {
                state.mood[selectedCharacter] = "neutral";
                renderContent();
            }, 2000);
        };
        
        // --- RENDER FUNCTIONS (DOM) ---
        
        const renderAll = () => {
             renderHeader();
             renderTabNav();
             renderContent();
        };

        const renderHeader = () => {
            const headerElement = document.getElementById('app-header');
            const totalSatisfaction = getTotalSatisfaction();

            headerElement.innerHTML = `
                <h1 class="text-5xl sm:text-6xl font-extrabold text-pink-600 mb-4 font-['Inter'] drop-shadow-lg">
                    üçΩÔ∏è ƒÇn C·∫£ Th·∫ø Gi·ªõi C√πng Chiikawa
                </h1>
                <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-8 p-4 bg-pink-100 rounded-2xl shadow-xl">
                    <p class="text-xl font-bold text-gray-700">
                        T·ªïng H√†i L√≤ng: <span class="font-black text-pink-700 text-2xl">${totalSatisfaction}</span>
                    </p>
                    <p class="text-xl font-bold text-gray-700">
                        üí∞ Ti·ªÅn (Gold): <span class="font-black text-yellow-600 text-2xl">${state.money} G</span>
                    </p>
                </div>
                
                <!-- Khu v·ª±c Tr√¨nh Ph√°t Nh·∫°c & ƒê·ªïi Nh·∫°c -->
                <div class="mt-4 p-4 bg-purple-100 border-4 border-purple-300 rounded-3xl shadow-2xl flex flex-col items-center max-w-4xl mx-auto">
                    <p class="text-2xl font-black text-purple-700 mb-3">üé∂ Nh·∫°c N·ªÅn Chiikawa</p>
                    <!-- Audio Element (S·ª≠ d·ª•ng state.musicUrl) -->
                    <audio controls autoplay loop src="${state.musicUrl}" class="w-full max-w-lg mb-4 rounded-lg"></audio>

                    <!-- T√≠nh nƒÉng Th√™m Nh·∫°c (C·∫≠p nh·∫≠t) -->
                    <div class="w-full max-w-lg text-sm bg-white p-4 rounded-xl shadow-inner space-y-4 border border-purple-200">
                        <p class="text-sm font-semibold text-purple-600 mb-2 border-b pb-1">C·∫≠p Nh·∫≠t Nh·∫°c N·ªÅn</p>
                        
                        <!-- 1. ƒê·ªïi nh·∫°c b·∫±ng T√™n file/URL -->
                        <div>
                            <p class="text-sm font-semibold text-purple-600 mb-1">T√πy ch·ªçn 1: Nh·∫≠p T√™n File/URL</p>
                            <div class="flex space-x-2">
                                <input 
                                    type="text" 
                                    id="new-music-url" 
                                    placeholder="V√≠ d·ª•: chiiik.WAV ho·∫∑c link tr·ª±c ti·∫øp" 
                                    value="${state.musicUrl.startsWith('blob:') ? 'ƒê√£ t·∫£i file' : state.musicUrl}"
                                    class="flex-grow p-2 border border-gray-300 rounded-xl text-sm disabled:bg-gray-100"
                                    ${state.musicUrl.startsWith('blob:') ? 'disabled' : ''}
                                >
                                <button 
                                    onclick="handleUpdateMusicUrl()"
                                    class="bg-purple-500 hover:bg-purple-600 text-white text-sm font-bold px-4 py-2 rounded-xl transition-colors transform active:scale-95 disabled:bg-gray-400 shadow-md"
                                    ${state.musicUrl.startsWith('blob:') ? 'disabled' : ''}
                                >
                                    C·∫≠p Nh·∫≠t URL
                                </button>
                            </div>
                        </div>
                        
                        <!-- 2. ƒê·ªïi nh·∫°c b·∫±ng File Upload -->
                        <div>
                            <p class="text-sm font-semibold text-purple-600 mb-1">T√πy ch·ªçn 2: T·∫£i l√™n File Nh·∫°c (.mp3, .wav...)</p>
                            <label for="music-upload" class="flex items-center space-x-2 p-3 border-2 border-dashed border-pink-400 rounded-xl cursor-pointer bg-pink-50 hover:bg-pink-100 transition-colors shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-pink-500" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L6.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                </svg>
                                <span class="text-sm font-bold text-pink-700">Ch·ªçn file nh·∫°c t·ª´ m√°y t√≠nh c·ªßa b·∫°n</span>
                                <input 
                                    type="file" 
                                    id="music-upload" 
                                    accept="audio/*" 
                                    onchange="handleMusicFileUpload(event)"
                                    class="hidden"
                                >
                            </label>
                        </div>
                    </div>
                </div>
            `;
        };
        
        const renderTabNav = () => {
            const tabNavElement = document.getElementById('tab-nav');
            const activeClass = "bg-pink-500 text-white shadow-lg border-pink-500 font-black";
            const inactiveClass = "text-gray-500 hover:bg-pink-50 hover:text-pink-600 font-semibold";

            tabNavElement.innerHTML = `
                <button
                    onclick="setActiveTab('eat')"
                    class="px-8 py-3 text-xl rounded-t-xl transition-all duration-200 border-b-4 ${
                        state.activeTab === 'eat' ? activeClass : inactiveClass
                    }"
                >
                    üç¥ B·ªØa Ti·ªác (ƒÇn U·ªëng)
                </button>
                <button
                    onclick="setActiveTab('shop')"
                    class="px-8 py-3 text-xl rounded-t-xl transition-all duration-200 border-b-4 ${
                        state.activeTab === 'shop' ? activeClass : inactiveClass
                    }"
                >
                    üõçÔ∏è C·ª≠a H√†ng (Menu)
                </button>
            `;
        };

        // S·ª¨A L·ªñI: G√°n setActiveTab v√†o window ƒë·ªÉ n√≥ c√≥ th·ªÉ ƒë∆∞·ª£c g·ªçi t·ª´ onclick inline
        window.setActiveTab = (tab) => {
            state.activeTab = tab;
            renderTabNav();
            renderContent();
        };

        const renderContent = () => {
            const contentElement = document.getElementById('main-content');
            if (state.activeTab === 'eat') {
                contentElement.innerHTML = renderEating();
            } else {
                contentElement.innerHTML = renderShop();
            }
        };

        const renderCharacterDisplay = (name) => {
            const charEmoji = name === "Chiikawa" ? "üê≠" : name === "Hachiware" ? "üê±" : "üê∞";
            const charMood = state.mood[name];
            let emoji = charEmoji; 
            let color = "bg-gray-100";
            let moodText = "B√¨nh th∆∞·ªùng";

            if (charMood === "happy") {
                emoji = "üòä"; 
                color = "bg-yellow-200";
                moodText = "Vui v·∫ª";
            } else if (charMood === "very_happy") {
                emoji = "üíñ"; 
                color = "bg-pink-300 animate-pulse";
                moodText = "R·∫•t H√†i L√≤ng!";
            } else if (charMood === "sad") {
                emoji = "üò¢";
                color = "bg-red-200";
                moodText = "Bu·ªìn";
            } else {
                emoji = charEmoji;
                color = "bg-blue-100";
            }


            return `
                <div 
                    onclick="handleSelectCharacter('${name}')"
                    class="character-card p-4 rounded-3xl shadow-xl transition-all duration-300 flex flex-col items-center cursor-pointer transform hover:scale-[1.02]
                        ${state.selectedCharacter === name ? 'selected' : 'bg-white border-2 border-gray-100'}
                    "
                >
                    <div class="p-4 rounded-full ${color} w-20 h-20 flex items-center justify-center text-4xl mb-2 border-4 border-white shadow-inner">
                        ${emoji}
                    </div>
                    <p class="font-extrabold text-xl text-gray-800">${name}</p>
                    <p class="text-xs text-purple-500 font-semibold mb-2">${moodText}</p>
                    
                    <div class="w-full mt-2">
                        <p class="text-xs text-pink-500 font-bold mb-1">
                            H√†i L√≤ng: <span class="font-extrabold">${state.characterSatisfaction[name]}</span>
                        </p>
                        <!-- Thanh ti·∫øn tr√¨nh (Gi·∫£ ƒë·ªãnh max 500 ƒëi·ªÉm cho progress bar) -->
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(100, (state.characterSatisfaction[name] / 500) * 100)}%;"></div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderItemCard = (item) => {
             const isSelected = state.selectedItem.id === item.id && state.selectedItem.category === item.category;
             const inventoryCount = getInventoryCount(item);
             const cardTitle = item.category === 'food' ? 'ƒê·ªì ƒÇn' : 'N∆∞·ªõc U·ªëng';
             const categoryColor = item.category === 'food' ? 'pink' : 'green';
             
             return `
                <div
                    onclick="handleSelectItem(${item.id}, '${item.category}')"
                    class="p-4 rounded-xl shadow-lg cursor-pointer transition-transform duration-200 transform hover:scale-105 border-4 bg-white 
                        ${isSelected ? `ring-4 ring-${categoryColor}-500 border-${categoryColor}-700 shadow-2xl` : `border-${categoryColor}-200 shadow-md`}
                        ${getTypeColor(item.type)}"
                >
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-4xl">${item.emoji}</span>
                        <span class="bg-${categoryColor}-500 text-white text-sm font-bold px-3 py-1 rounded-full shadow-md">x${inventoryCount}</span>
                    </div>
                    
                    <p class="font-extrabold text-gray-800 text-md truncate">${item.name}</p>
                    <p class="text-xs text-green-700 font-bold">T·ªß: ${item.favoriteCharacter}</p>
                    <p class="text-xs text-red-600 font-bold">Tr√°nh: ${getSauceById(item.avoidSauceId).emoji}</p>
                </div>
            `;
        };

        const renderEating = () => {
            const sauce = state.selectedSauceId ? getSauceById(state.selectedSauceId) : null;
            const selectedItemData = getItemDataFromState(state.selectedItem);
            
            let html = `
                <!-- 1. Tr·∫°ng th√°i Chiikawa, Hachiware, Usagi -->
                <h2 class="text-3xl font-black text-pink-600 mb-6 border-b pb-3">üë™ T√¨nh Tr·∫°ng H√†i L√≤ng c·ªßa Nh√≥m</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                    ${renderCharacterDisplay("Chiikawa")}
                    ${renderCharacterDisplay("Hachiware")}
                    ${renderCharacterDisplay("Usagi")}
                </div>
                
                <!-- 2. Khu v·ª±c Ph·∫£n h·ªìi v√† H√†nh ƒë·ªông -->
                <div class="mb-10 p-5 bg-purple-200 border-4 border-purple-500 rounded-3xl text-center shadow-2xl">
                    <p class="font-extrabold text-purple-900 transition-opacity duration-500 ${state.feedback.includes('PERFECT') ? 'text-2xl animate-bounce' : 'text-xl'}">
                        ${state.feedback}
                    </p>
                </div>

                <!-- 3. Khu v·ª±c ƒÇn Ch√≠nh -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- C·ªôt 1: V·∫≠t Ph·∫©m Ch√≠nh ƒêang Ch·ªçn -->
                    <div class="lg:col-span-1 p-6 bg-yellow-50 chiikawa-card border-4 border-yellow-300">
                        <h3 class="text-2xl font-black text-yellow-700 mb-4 border-b pb-2">V·∫≠t Ph·∫©m ƒêang Ch·ªçn</h3>
                        <div class="text-center p-4 rounded-2xl bg-white shadow-inner">
                            <div class="text-6xl mb-3">${selectedItemData.emoji}</div>
                            <p class="font-black text-gray-800 text-xl mb-3">
                                ${selectedItemData.name}
                                <span class="bg-pink-500 text-white text-xs font-bold px-2 py-0.5 rounded-full ml-2">x${getInventoryCount(selectedItemData)}</span>
                            </p>
                            <p class="text-sm font-semibold text-gray-500 mb-3">Lo·∫°i: ${selectedItemData.category === 'food' ? 'ƒê·ªì ƒÇn' : 'N∆∞·ªõc Gi·∫£i Kh√°t'}</p>
                            
                            <!-- S·ªü th√≠ch chi ti·∫øt -->
                            <div class="mt-4 p-3 rounded-xl bg-green-100 border border-green-300">
                                <p class="text-sm text-gray-700 font-bold">üéØ M√ìN T·ª¶ C·ª¶A: <span class="text-green-700 font-extrabold">${selectedItemData.favoriteCharacter}</span></p>
                            </div>
                            
                            <div class="mt-2 p-3 rounded-xl bg-red-100 border border-red-300">
                                <p class="text-sm text-gray-700 font-bold">üö´ GH√âT K·∫æT H·ª¢P V·ªöI: <span class="text-red-700 font-extrabold">${getAvoidSauceName(selectedItemData)}</span></p>
                                <p class="text-xs text-red-500 italic">Th·∫•t v·ªçng n·∫∑ng: ${selectedItemData.criticalFailCharacter}</p>
                            </div>
                        </div>

                        <!-- N√∫t ƒÇn -->
                        <div class="mt-6 flex justify-center">
                            <button
                                onclick="handleEatFood()"
                                class="w-full px-8 py-4 bg-pink-500 hover:bg-pink-600 text-white font-black rounded-full shadow-lg transform active:scale-95 transition-all duration-150 disabled:bg-gray-400 text-xl"
                                ${getInventoryCount(selectedItemData) <= 0 ? 'disabled' : ''}
                            >
                                üçΩÔ∏è Cho ${state.selectedCharacter} ƒÇn!
                            </button>
                        </div>
                    </div>
                    
                    <!-- C·ªôt 2: Kho N∆∞·ªõc S·ªët -->
                    <div class="lg:col-span-2 p-6 bg-blue-50 chiikawa-card border-4 border-blue-300">
                        <h3 class="text-2xl font-black text-blue-700 mb-4 border-b pb-2">üß™ Kho N∆∞·ªõc S·ªët (Nh·∫•p ƒë·ªÉ ch·ªçn)</h3>
                        <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-5 gap-4">
                            ${SAUCES.map(s => `
                                <button
                                    onclick="handleSelectSauce('${s.id}')"
                                    class="p-3 rounded-xl shadow-md transition-all duration-200 transform hover:scale-105 
                                        ${(state.sauceInventory[s.id] || 0) > 0 ? 'bg-white hover:bg-blue-100 cursor-pointer' : 'bg-gray-200 cursor-not-allowed'}
                                        ${state.selectedSauceId === s.id ? 'ring-4 ring-purple-500 border-4 border-white shadow-xl' : 'border-2 border-gray-100'}
                                        "
                                    ${(state.sauceInventory[s.id] || 0) <= 0 ? 'disabled' : ''}
                                >
                                    <div class="text-4xl">${s.emoji}</div>
                                    <p class="font-bold text-gray-800 text-sm truncate">${s.name}</p>
                                    <p class="text-xs text-blue-600 font-extrabold">x${state.sauceInventory[s.id] || 0}</p>
                                    ${state.selectedSauceId === s.id ? '<p class="text-xs text-purple-700 mt-1 font-black">CH·ªåN</p>' : ''}
                                </button>
                            `).join('')}
                        </div>
                        <p class="text-right text-xs text-gray-500 italic mt-4">
                            *S·ªët ƒë√£ ch·ªçn: ${sauce ? sauce.emoji + " " + sauce.name : "Kh√¥ng"}
                        </p>
                    </div>
                </div>

                <!-- 4. Kho ƒê·ªì ƒÇn -->
                <h2 class="text-3xl font-black text-pink-600 mt-10 mb-4 border-b pb-3">üì¶ Kho ƒê·ªì ƒÇn (120 M√≥n - Nh·∫•p ƒë·ªÉ ch·ªçn)</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                    ${FOOD_MENU.filter(food => getInventoryCount(food) > 0).map((food) => renderItemCard(food)).join('')}
                </div>
                ${FOOD_MENU.filter(food => getInventoryCount(food) > 0).length === 0 ? 
                    '<p class="text-center text-gray-500 mt-6 text-lg font-semibold">Kho ƒë·ªì ƒÉn ƒëang tr·ªëng. H√£y v√†o C·ª≠a H√†ng ƒë·ªÉ mua ƒë·ªì ƒÉn!</p>' : ''
                }
                
                <!-- 5. Kho N∆∞·ªõc Gi·∫£i Kh√°t -->
                <h2 class="text-3xl font-black text-green-600 mt-10 mb-4 border-b pb-3">ü•§ Kho N∆∞·ªõc Gi·∫£i Kh√°t (35 M√≥n - Nh·∫•p ƒë·ªÉ ch·ªçn)</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                    ${BEVERAGES.filter(beverage => getInventoryCount(beverage) > 0).map((beverage) => renderItemCard(beverage)).join('')}
                </div>
                ${BEVERAGES.filter(beverage => getInventoryCount(beverage) > 0).length === 0 ? 
                    '<p class="text-center text-gray-500 mt-6 text-lg font-semibold">Kho n∆∞·ªõc gi·∫£i kh√°t ƒëang tr·ªëng. H√£y v√†o C·ª≠a H√†ng ƒë·ªÉ mua n∆∞·ªõc u·ªëng!</p>' : ''
                }
            `;
            return html;
        };

        const renderShop = () => {
            let html = `
                <h2 class="text-3xl font-black text-pink-600 mb-4">üõçÔ∏è C·ª≠a H√†ng Menu ƒê·∫∑c Bi·ªát</h2>
                <p class="text-gray-600 mb-8 text-lg">D√πng Gold (G) ƒë·ªÉ mua ƒë·ªì ƒÉn, n∆∞·ªõc s·ªët v√† n∆∞·ªõc gi·∫£i kh√°t. T·ªïng ti·ªÅn c·ªßa b·∫°n: <span class="font-extrabold text-yellow-600">${state.money} G</span></p>
                
                <!-- N∆∞·ªõc S·ªët -->
                <h3 class="text-2xl font-black text-blue-700 mb-4 border-b-2 border-blue-300 pb-2">üß™ N∆∞·ªõc S·ªët ƒê·∫∑c Bi·ªát (15 Lo·∫°i)</h3>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 mb-10">
                    ${SAUCES.map((sauce) => `
                        <div class="p-4 rounded-3xl shadow-xl border-4 border-blue-200 transition-transform duration-200 bg-white hover:scale-105 flex flex-col items-center">
                            <div class="text-4xl mb-2">${sauce.emoji}</div>
                            <p class="font-extrabold text-gray-800 text-md text-center truncate mb-1">${sauce.name}</p>
                            <p class="text-xs text-gray-600 text-center">Bonus: +${sauce.bonus} ƒëi·ªÉm</p>
                            
                            <div class="mt-3 flex items-center justify-between w-full px-1">
                                <span class="font-black text-blue-700 text-xl">${sauce.price} G</span>
                                <button
                                    onclick="handleBuyItem({ id: '${sauce.id}', name: '${sauce.name}', price: ${sauce.price}, category: 'sauce' })"
                                    class="bg-blue-500 hover:bg-blue-600 text-white text-sm px-3 py-1 rounded-full font-bold transform active:scale-95 shadow-md"
                                >
                                    Mua (1)
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <!-- N∆∞·ªõc Gi·∫£i Kh√°t -->
                <h3 class="text-2xl font-black text-green-700 mb-4 border-b-2 border-green-300 pb-2">ü•§ N∆∞·ªõc Gi·∫£i Kh√°t (35 Lo·∫°i)</h3>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 mb-10">
                    ${BEVERAGES.map((beverage) => `
                        <div class="p-4 rounded-3xl shadow-xl border-4 border-green-200 transition-transform duration-200 bg-white hover:scale-105 flex flex-col items-center">
                            <div class="text-4xl mb-2">${beverage.emoji}</div>
                            <p class="font-extrabold text-gray-800 text-md text-center truncate mb-1">${beverage.name}</p>
                            <p class="text-xs text-pink-700 font-bold">M√≥n t·ªß: ${beverage.favoriteCharacter}</p>
                            
                            <div class="mt-3 flex items-center justify-between w-full px-1">
                                <span class="font-black text-green-700 text-xl">${beverage.price} G</span>
                                <button
                                    onclick="handleBuyItem({ id: ${beverage.id}, name: '${beverage.name}', price: ${beverage.price}, category: 'beverage' })"
                                    class="bg-green-500 hover:bg-green-600 text-white text-sm px-3 py-1 rounded-full font-bold transform active:scale-95 shadow-md"
                                >
                                    Mua (1)
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <!-- ƒê·ªì ƒÇn -->
                <h3 class="text-2xl font-black text-pink-700 mb-4 border-b-2 border-pink-300 pb-2">üç∞ ƒê·ªì ƒÇn (120 M√≥n)</h3>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                    ${FOOD_MENU.map((food) => `
                        <div class="p-4 rounded-3xl shadow-xl border-4 border-pink-200 transition-transform duration-200 transform hover:scale-105 bg-white flex flex-col items-center">
                            <div class="text-4xl mb-2">${food.emoji}</div>
                            <p class="font-extrabold text-gray-800 text-md text-center truncate mb-1">${food.name}</p>
                            <p class="text-xs text-green-700 font-bold">M√≥n t·ªß: ${food.favoriteCharacter}</p>
                            
                            <div class="mt-3 flex items-center justify-between w-full px-1">
                                <span class="font-black text-pink-700 text-xl">${food.price} G</span>
                                <button
                                    onclick="handleBuyItem({ id: ${food.id}, name: '${food.name}', price: ${food.price}, category: 'food' })"
                                    class="bg-pink-500 hover:bg-pink-600 text-white text-sm px-3 py-1 rounded-full font-bold transform active:scale-95 shadow-md"
                                >
                                    Mua (1)
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            return html;
        };

        const initializeApp = async () => {
            // Kh·ªüi t·∫°o tr·∫°ng th√°i m·∫∑c ƒë·ªãnh ngay l·∫≠p t·ª©c
            state = getDefaultState();
            
            // Render giao di·ªán
            renderAll();
            
            // X·ª≠ l√Ω nh·∫°c n·ªÅn ban ƒë·∫ßu
            const audio = document.querySelector('audio');
            if (audio) {
                audio.volume = 0.3; // Gi·∫£m √¢m l∆∞·ª£ng m·∫∑c ƒë·ªãnh
            }
        };
        
        // Kh·ªüi ch·∫°y ·ª©ng d·ª•ng khi DOM ƒë√£ s·∫µn s√†ng
        window.onload = initializeApp;
    </script>
</body>
</html>
